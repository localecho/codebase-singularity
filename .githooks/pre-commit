#!/bin/bash
# Pre-commit hook for Codebase Singularity
# Scans for potential secrets before committing

set -e

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "ğŸ” Running pre-commit security checks..."

# Files to check (staged files only)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}âœ“ No files to check${NC}"
    exit 0
fi

# Secret patterns to detect
SECRET_PATTERNS=(
    # API Keys
    "sk-[a-zA-Z0-9]{32,}"                    # OpenAI
    "sk_live_[a-zA-Z0-9]{24,}"               # Stripe live
    "sk_test_[a-zA-Z0-9]{24,}"               # Stripe test
    "rk_live_[a-zA-Z0-9]{24,}"               # Stripe restricted

    # Cloud providers
    "AKIA[0-9A-Z]{16}"                       # AWS Access Key ID
    "ASIA[0-9A-Z]{16}"                       # AWS Session Token
    "AIza[0-9A-Za-z_-]{35}"                  # Google API Key

    # GitHub
    "ghp_[a-zA-Z0-9]{36}"                    # GitHub PAT
    "gho_[a-zA-Z0-9]{36}"                    # GitHub OAuth
    "ghu_[a-zA-Z0-9]{36}"                    # GitHub User
    "ghs_[a-zA-Z0-9]{36}"                    # GitHub Server
    "ghr_[a-zA-Z0-9]{36}"                    # GitHub Refresh

    # Database URLs with credentials
    "postgres://[^:]+:[^@]+@"                # PostgreSQL
    "mysql://[^:]+:[^@]+@"                   # MySQL
    "mongodb://[^:]+:[^@]+@"                 # MongoDB
    "mongodb\+srv://[^:]+:[^@]+@"            # MongoDB Atlas

    # Generic secrets
    "password\s*=\s*['\"][^'\"]{8,}['\"]"    # password = "..."
    "api[_-]?key\s*=\s*['\"][^'\"]{16,}['\"]" # api_key = "..."
    "secret[_-]?key\s*=\s*['\"][^'\"]{16,}['\"]" # secret_key = "..."

    # Private keys
    "-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----"
    "-----BEGIN PGP PRIVATE KEY BLOCK-----"
)

FOUND_SECRETS=0
WARNINGS=()

for file in $STAGED_FILES; do
    # Skip binary files
    if file "$file" | grep -q "binary"; then
        continue
    fi

    # Skip certain file types
    case "$file" in
        *.lock|*.min.js|*.min.css|package-lock.json|yarn.lock)
            continue
            ;;
    esac

    # Get staged content (not working directory)
    CONTENT=$(git show ":$file" 2>/dev/null || cat "$file" 2>/dev/null || echo "")

    if [ -z "$CONTENT" ]; then
        continue
    fi

    for pattern in "${SECRET_PATTERNS[@]}"; do
        if echo "$CONTENT" | grep -qE "$pattern"; then
            FOUND_SECRETS=$((FOUND_SECRETS + 1))
            WARNINGS+=("$file: Potential secret matching pattern: $pattern")
        fi
    done

    # Special handling for CLAUDE.md
    if [[ "$file" == *"CLAUDE.md"* ]]; then
        # Extra-strict checking for CLAUDE.md
        if echo "$CONTENT" | grep -qEi "(api.?key|password|secret|token|credential)\s*[:=]"; then
            FOUND_SECRETS=$((FOUND_SECRETS + 1))
            WARNINGS+=("$file: CLAUDE.md may contain sensitive configuration")
        fi
    fi
done

if [ $FOUND_SECRETS -gt 0 ]; then
    echo ""
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘          âš ï¸  POTENTIAL SECRETS DETECTED!                    â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}The following issues were found:${NC}"
    echo ""
    for warning in "${WARNINGS[@]}"; do
        echo -e "  ${RED}â€¢${NC} $warning"
    done
    echo ""
    echo -e "${YELLOW}Recommendations:${NC}"
    echo "  1. Move secrets to environment variables"
    echo "  2. Use a secrets manager (Vault, AWS Secrets Manager, etc.)"
    echo "  3. Add sensitive files to .gitignore"
    echo ""
    echo -e "To bypass this check (NOT RECOMMENDED):"
    echo -e "  git commit --no-verify"
    echo ""
    exit 1
fi

echo -e "${GREEN}âœ“ No secrets detected${NC}"
exit 0
